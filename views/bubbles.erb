<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <link rel="stylesheet" type="text/css" href="style.css">
  <title>BUBBLES!</title>
</head>
<body>
  <div class="wrapper"></div>

  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="bubbles.js"></script>
  <script>
    function setupStream(stream_uri) {
      var json, type, color;

      stream = new EventSource(stream_uri)

      stream.onmessage = function(event) {
        json = JSON.parse(event.data);

        type  = json.type || 'none';
        color = json.color;

        new Bubble().init(type, color);
      }
    }

    <% "/stream|#{ENV['STREAMS']}".split('|').each do |stream| %>
      setupStream("<%= stream %>");
    <% end %>

    <% if ENV['FLOW_DOCK_API_TOKEN'] %>
      <% (ENV['FLOW_DOCK_CHANNELS'] || '').split(',').each do |channel| %>
        var flow_stream = new EventSource('https://<%= ENV['FLOW_DOCK_API_TOKEN'] %>@stream.flowdock.com/flows?filter=<%= channel %>')

        flow_stream.onmessage = function(event) {
          console.log(event);

          json = JSON.parse(event.data);

          type = json.type || 'none';

          new Bubble().init(type, null);
        }
      <% end %>
    <% end %>
  </script>
</body>
</html>
